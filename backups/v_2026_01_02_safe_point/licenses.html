<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุชุญููู ุงูุชุฑุงุฎูุต | Licenses Dashboard</title>
    <link rel="stylesheet" href="style-admin.css">
    <link rel="icon" type="image/svg+xml" href="olayan-mark.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js" defer></script>
    <script src="admin.js?v=6" defer></script>
</head>
<body class="admin-body ar">

    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <img src="olayan-logo.png" class="sidebar-logo" alt="Logo">
                <span class="sidebar-brand">ููุญุฉ ุงูุชุญูู</span>
            </div>
            <nav class="sidebar-nav">
                <!-- Group 1: Leadership -->
                <div class="nav-group" id="group-leadership">
                    <div class="nav-group-header" onclick="toggleSidebarGroup('group-leadership')">
                        <span>๐ ุงูููุงุฏุฉ ูุงูุชุญููู</span>
                        <i class="arrow-icon">โถ</i>
                    </div>
                    <div class="nav-group-content" style="display:none;">
                        <a href="admin.html" class="nav-item" id="nav-dashboard">
                            <i>๐</i> ุงูุฑุฆูุณูุฉ
                        </a>
                        <a href="admin.html" class="nav-item" id="nav-analytics">
                            <i>๐ง</i> ุงูุชุญููู ุงูุงุณุชุฑุงุชูุฌู (AI)
                        </a>
                        <a href="admin.html" class="nav-item" id="nav-tasks">
                            <i>โ</i> ุงูููุงู
                        </a>
                    </div>
                </div>

                <!-- Group 2: Data Management -->
                <div class="nav-group active" id="group-data">
                    <div class="nav-group-header" onclick="toggleSidebarGroup('group-data')">
                        <span>๐ ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช</span>
                        <i class="arrow-icon">โผ</i>
                    </div>
                    <div class="nav-group-content">
                        <a href="admin.html" class="nav-item" id="nav-employees">
                            <i>๐ฅ</i> ุงูููุธููู
                        </a>
                        <a href="violations.html" class="nav-item" id="nav-violations">
                            <i>โ๏ธ</i> ุงููุฎุงููุงุช
                        </a>
                        <a href="training.html" class="nav-item" id="nav-training">
                            <i>๐</i> ุงูุชุฏุฑูุจ
                        </a>
                        <a href="branches.html" class="nav-item" id="nav-branches">
                            <i>๐ฌ</i> ุงููุฑูุน
                        </a>
                        <a href="licenses.html" class="nav-item active" id="nav-licenses">
                            <i>๐</i> ุงูุชุฑุงุฎูุต
                        </a>
                        <a href="admin.html" class="nav-item" id="nav-advanced-data">
                            <i>๐พ</i> ุงูุจูุงูุงุช ุงููุชูุฏูุฉ
                        </a>
                    </div>
                </div>

                <!-- Group 3: Users & Services -->
                <div class="nav-group" id="group-users">
                    <div class="nav-group-header" onclick="toggleSidebarGroup('group-users')">
                        <span>๐ฅ ุงููุณุชุฎุฏููู ูุงูุดูุงูู</span>
                        <i class="arrow-icon">โถ</i>
                    </div>
                    <div class="nav-group-content" style="display:none;">
                        <a href="admin.html" class="nav-item" id="nav-users">
                            <i>๐ค</i> ุงูุฃุนุถุงุก
                        </a>
                        <a href="admin.html" class="nav-item" id="nav-services">
                            <i>๐ฉ</i> ุงูุดูุงูู ูุงูุทูุจุงุช
                        </a>
                    </div>
                </div>

                <!-- Group 4: System -->
                <div class="nav-group" id="group-system">
                    <div class="nav-group-header" onclick="toggleSidebarGroup('group-system')">
                        <span>โ๏ธ ุฅุนุฏุงุฏุงุช ุงููุธุงู</span>
                        <i class="arrow-icon">โถ</i>
                    </div>
                    <div class="nav-group-content" style="display:none;">
                        <a href="admin.html" class="nav-item" id="nav-settings">
                            <i>โ๏ธ</i> ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ
                        </a>
                        <a href="admin.html" class="nav-item"><i>๐ผ๏ธ</i> ุงููุณุงุฆุท</a>
                        <a href="admin.html" class="nav-item"><i>๐</i> ุงูุตูุญุงุช</a>
                        <a href="admin.html" class="nav-item"><i>๐ฌ</i> ุงูุชุนูููุงุช</a>
                        <a href="admin.html" class="nav-item"><i>๐จ</i> ุงููุธูุฑ</a>
                        <a href="admin.html" class="nav-item"><i>๐งฉ</i> ุงูุฅุถุงูุงุช</a>
                        <a href="admin.html" class="nav-item"><i>๐๏ธ</i> ุงูุฃุฏูุงุช</a>
                        <a href="admin.html" class="nav-item"><i>โ๏ธ</i> ุงูุจุฑูุฏ</a>
                    </div>
                </div>

                <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 20px;"></div>
                
                <a href="board.html" target="_blank" class="nav-item" style="margin: 0 10px;">
                    <i>๐</i> ุงูุฐูุงุจ ูููููุน
                </a>
            </nav>
            <div style="padding: 20px;">
                <button id="logout" class="btn btn-danger" style="width: 100%; justify-content: center;" onclick="location.href='index.html'">ุชุณุฌูู ุฎุฑูุฌ</button>
            </div>
            <div class="sidebar-footer" style="padding: 10px 20px; text-align: center; font-size: 0.7rem; color: #64748b; border-top: 1px solid #eee;">
                <div style="margin-bottom: 5px;">ุฌููุน ุงูุญููู ูุญููุธุฉ ูุฏู ุดุฑูุฉ ุงูุนููุงู ููุฎุฏูุงุช ุงูุบุฐุงุฆูุฉ ยฉ 2025</div>
                <div style="direction: ltr;">Developed by Bandar A. Abdulwahab</div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <button id="sidebar-toggle" class="btn btn-secondary" style="margin-inline-end: 10px; display: none;">โฐ</button>
                <div class="header-title">ููุญุฉ ุชุญููู ุงูุชุฑุงุฎูุต ูุชุตุงุฑูุญ ุงูุฏูุงุน ุงููุฏูู</div>
                <div class="header-actions">
                    <button onclick="location.reload()" class="btn btn-secondary">๐ ุชุญุฏูุซ</button>
                    
                    <div class="user-profile">
                        <div class="user-info">
                            <div class="user-name">Admin</div>
                            <div class="user-role">ูุณุคูู ุงููุธุงู</div>
                        </div>
                        <div class="user-avatar">A</div>
                    </div>
                </div>
            </header>

            <div class="admin-content-wrapper">
                
                <!-- Control Section (Upload) -->
                <div class="card-section" style="margin-bottom: 30px; background: linear-gradient(to left, rgba(16, 185, 129, 0.1), rgba(30, 41, 75, 0.4)); border-color: rgba(16, 185, 129, 0.2);">
                    <div class="section-header">
                        <span class="section-title" style="color: #10b981;">๐ค ุชุญุฏูุซ ุงูุจูุงูุงุช (Control)</span>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <p style="margin: 0; color: #94a3b8; font-size: 0.9rem;">
                            ูู ุจุฑูุน ููู Excel ูุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ูู ุงูููุญุฉ ุฃุฏูุงู.
                        </p>
                        <input type="file" id="lic-excel-file" accept=".xlsx, .xls, .csv" style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('lic-excel-file').click()" style="background-color: #10b981;">๐ ุฑูุน ููู Excel</button>
                        <button class="btn btn-secondary" onclick="downloadLicensesTemplate()">โฌ๏ธ ุชุญููู ูููุฐุฌ</button>
                        <span id="lic-file-name" style="color: #fff; font-size: 0.9rem;"></span>
                        
                        <div style="margin-right: auto; display: flex; gap: 10px;">
                            <button onclick="clearLicensesData()" class="btn btn-danger" style="font-size: 0.8rem;">๐๏ธ ูุณุญ ุงูุจูุงูุงุช</button>
                        </div>
                    </div>
                </div>

                <!-- KPIs Row -->
                <div class="dash-metrics-row">
                    <div class="dash-metric-card">
                        <div class="dm-icon" style="color:#4facfe;">๐ฌ</div>
                        <div class="dm-info">
                            <h4>ุฅุฌูุงูู ุงููุฑูุน</h4>
                            <span class="dm-val" id="kpi-total">0</span>
                        </div>
                    </div>
                    <div class="dash-metric-card" style="border-color: rgba(239, 68, 68, 0.3);">
                        <div class="dm-icon" style="color:#ef4444;">๐</div>
                        <div class="dm-info">
                            <h4>ุฑุฎุต ููุชููุฉ (Store)</h4>
                            <span class="dm-val" id="kpi-store-exp" style="color: #ef4444;">0</span>
                        </div>
                    </div>
                    <div class="dash-metric-card" style="border-color: rgba(239, 68, 68, 0.3);">
                        <div class="dm-icon" style="color:#ef4444;">๐</div>
                        <div class="dm-info">
                            <h4>ุฏูุงุน ูุฏูู ููุชูู</h4>
                            <span class="dm-val" id="kpi-civil-exp" style="color: #ef4444;">0</span>
                        </div>
                    </div>
                    <div class="dash-metric-card">
                        <div class="dm-icon" style="color:#10b981;">๐ฐ</div>
                        <div class="dm-info">
                            <h4>ุฅุฌูุงูู ุงูุชูููุฉ ุงูุชุดุบูููุฉ</h4>
                            <span class="dm-val" id="kpi-cost" style="color: #10b981; font-size: 1.5rem;">0</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="dash-grid-split" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); margin-bottom: 30px;">
                    <div class="dash-panel">
                        <div class="dash-panel-header">
                            <span class="dash-panel-title">ุญุงูุฉ ุงูุฏูุงุน ุงููุฏูู (Civil Defense)</span>
                        </div>
                        <div style="height: 250px;">
                            <canvas id="chart-civil"></canvas>
                        </div>
                    </div>
                    <div class="dash-panel">
                        <div class="dash-panel-header">
                            <span class="dash-panel-title">ุญุงูุฉ ุฑุฎุตุฉ ุงูุจูุฏูุฉ (Store License)</span>
                        </div>
                        <div style="height: 250px;">
                            <canvas id="chart-store"></canvas>
                        </div>
                    </div>
                    <div class="dash-panel">
                        <div class="dash-panel-header">
                            <span class="dash-panel-title">ุงูุชูุฒูุน ุญุณุจ ุงูููุทูุฉ (Region)</span>
                        </div>
                        <div style="height: 250px;">
                            <canvas id="chart-region"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="dash-grid-split" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-bottom: 30px;">
                    <div class="dash-panel">
                        <div class="dash-panel-header">
                            <span class="dash-panel-title">ุงููุฑูุน ุญุณุจ ุงูุนูุงูุฉ (Brand)</span>
                        </div>
                        <div style="height: 250px;">
                            <canvas id="chart-brand"></canvas>
                        </div>
                    </div>
                    <div class="dash-panel">
                        <div class="dash-panel-header">
                            <span class="dash-panel-title">ุชุตุงุฑูุญ 24 ุณุงุนุฉ</span>
                        </div>
                        <div style="height: 250px;">
                            <canvas id="chart-24h"></canvas>
                        </div>
                    </div>
                    <div class="dash-panel">
                        <div class="dash-panel-header">
                            <span class="dash-panel-title">ุชุตุงุฑูุญ HD</span>
                        </div>
                        <div style="height: 250px;">
                            <canvas id="chart-hd"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Table Section -->
                <div class="card-section">
                    <div class="section-header">
                        <span class="section-title">ุชูุงุตูู ุงููุฑูุน ูุงูุชูุงููู</span>
                        <input type="text" id="search-table" class="form-control" style="width: 200px;" placeholder="ุจุญุซ..." onkeyup="filterTable()">
                    </div>
                    <div style="overflow-x: auto; max-height: 600px;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ุงููุฑุน</th>
                                    <th>ุงูููุทูุฉ</th>
                                    <th>ุฑุฎุตุฉ ุงูุจูุฏูุฉ</th>
                                    <th>ุงูุฏูุงุน ุงููุฏูู</th>
                                    <th>ุงูุชูููุฉ</th>
                                    <th>ุงูุนูุงูุฉ</th>
                                </tr>
                            </thead>
                            <tbody id="licenses-table-body">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Override admin.js render function to update charts when data changes
            // We save the original function first if it exists (it should from admin.js)
            const originalRender = window.renderLicensesTable;
            
            window.renderLicensesTable = function() {
                // 1. Run the original logic to populate the table with Cost inputs
                // We need to ensure the element ID matches what admin.js expects (licenses-table-body)
                // We renamed it in HTML to match.
                // Re-implementing specific parts if needed, but calling original is safer if available.
                
                // Since admin.js is defer, it might not be defined yet if this runs too early,
                // but this is inside DOMContentLoaded, so admin.js (defer) should have run.
                
                if (typeof originalRender === 'function') {
                    originalRender(); 
                } else {
                    // Fallback if admin.js logic isn't available or fails
                // Define safeParse locally if not available
                const safeParse = (k, d) => { try { return JSON.parse(localStorage.getItem(k)||JSON.stringify(d)); } catch(e){ return d; } };
                const data = safeParse('admin_licenses', []);
                renderTableFallback(data);
            }

            // 2. Update Dashboard Charts & KPIs
            updateDashboardStats();
        };

        // Initial Load
        setTimeout(window.renderLicensesTable, 100);
    });

    function updateDashboardStats() {
        // Define safeParse locally if not available
        const safeParse = (k, d) => { try { return JSON.parse(localStorage.getItem(k)||JSON.stringify(d)); } catch(e){ return d; } };
        const data = safeParse('admin_licenses', []);
        
        if (data.length === 0) {
                // Zero out KPIs
                document.getElementById('kpi-total').textContent = '0';
                document.getElementById('kpi-store-exp').textContent = '0';
                document.getElementById('kpi-civil-exp').textContent = '0';
                document.getElementById('kpi-cost').textContent = '0';
                return;
            }

            // --- Stats Calculation ---
            let total = data.length;
            let storeExp = 0, storeNear = 0, storeValid = 0;
            let civilExp = 0, civilNear = 0, civilValid = 0;
            let p24Valid = 0, p24Exp = 0;
            let hdValid = 0, hdExp = 0;
            let totalCost = 0;
            let regionMap = {};
            let brandMap = {};

            data.forEach(item => {
                // Costs
                totalCost += (item.cost || 0);

                // Store License
                const sStatus = (item.store_license?.status || '').toLowerCase();
                if (sStatus.includes('valid') || sStatus.includes('ุณุงุฑู')) storeValid++;
                else if (sStatus.includes('near') || sStatus.includes('close')) storeNear++;
                else storeExp++;

                // Civil Defense
                const cStatus = (item.civil_defense?.status || '').toLowerCase();
                if (cStatus.includes('valid') || cStatus.includes('ุณุงุฑู')) civilValid++;
                else if (cStatus.includes('near') || cStatus.includes('close')) civilNear++;
                else civilExp++;

                // Permits
                const p24 = (item.permit_24?.status || '').toLowerCase();
                if (p24.includes('valid') || p24.includes('yes') || p24.includes('ุณุงุฑู')) p24Valid++; else p24Exp++;

                const hd = (item.permit_hd?.status || '').toLowerCase();
                if (hd.includes('valid') || hd.includes('yes') || hd.includes('ุณุงุฑู')) hdValid++; else hdExp++;

                // Region & Brand Aggregation
                const region = item.region || 'Unknown';
                if(!regionMap[region]) regionMap[region] = 0;
                regionMap[region]++;

                const brand = item.brand || 'Unknown';
                if(!brandMap[brand]) brandMap[brand] = 0;
                brandMap[brand]++;
            });

            // Update KPIs
            document.getElementById('kpi-total').textContent = total;
            document.getElementById('kpi-store-exp').textContent = storeExp;
            document.getElementById('kpi-civil-exp').textContent = civilExp;
            document.getElementById('kpi-cost').textContent = totalCost.toLocaleString() + ' SAR';

            // Update Charts
            updateChart('chart-region', 'bar', Object.keys(regionMap), Object.values(regionMap), '#4facfe');
            updateChart('chart-brand', 'doughnut', Object.keys(brandMap), Object.values(brandMap), ['#f5c518', '#e11d48', '#f59e0b', '#10b981', '#6366f1']);
            updateChart('chart-civil', 'doughnut', ['ุณุงุฑู (Valid)', 'ูุฑูุจ ุงูุงูุชูุงุก', 'ููุชูู (Expired)'], [civilValid, civilNear, civilExp], ['#10b981', '#f59e0b', '#ef4444']);
            updateChart('chart-store', 'doughnut', ['ุณุงุฑู (Valid)', 'ูุฑูุจ ุงูุงูุชูุงุก', 'ููุชูู (Expired)'], [storeValid, storeNear, storeExp], ['#10b981', '#f59e0b', '#ef4444']);
            updateChart('chart-24h', 'pie', ['ููุฌุฏ (Yes)', 'ูุง ููุฌุฏ (No)'], [p24Valid, p24Exp], ['#3b82f6', '#475569']);
            updateChart('chart-hd', 'pie', ['ููุฌุฏ (Yes)', 'ูุง ููุฌุฏ (No)'], [hdValid, hdExp], ['#8b5cf6', '#475569']);
        }

        // Chart Instances Store
        const chartInstances = {};

        function updateChart(canvasId, type, labels, data, colors) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#94a3b8', font: { family: 'Segoe UI' } } }
                }
            };
            
            if(type === 'bar') {
                commonOptions.plugins.legend.display = false;
                commonOptions.scales = { y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } };
            }

            chartInstances[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Count',
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0,
                        borderRadius: type === 'bar' ? 4 : 0
                    }]
                },
                options: commonOptions
            });
        }

        function renderTableFallback(data) {
            const tbody = document.getElementById('licenses-table-body');
            tbody.innerHTML = '';
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:bold;">${item.branch}</td>
                    <td>${(item.cost||0).toLocaleString()}</td>
                    <td class="${getStatusClass(item.store_license.status)}">${item.store_license.status}</td>
                    <td class="${getStatusClass(item.civil_defense.status)}">${item.civil_defense.status}</td>
                    <td>${item.permit_24?.status || '-'}</td>
                    <td>${item.permit_hd?.status || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function getStatusClass(status) {
            if(!status) return '';
            const s = status.toLowerCase();
            if(s.includes('valid') || s.includes('ุณุงุฑู')) return 'status-valid';
            if(s.includes('near')) return 'status-near';
            return 'status-expired';
        }

        function filterTable() {
            const input = document.getElementById('search-table');
            const filter = input.value.toLowerCase();
            const rows = document.getElementById('licenses-table-body').getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const txt = rows[i].textContent.toLowerCase();
                rows[i].style.display = txt.includes(filter) ? "" : "none";
            }
        }
        
        // Add CSS class styles dynamically for status if not in style-admin.css
        const style = document.createElement('style');
        style.innerHTML = `
            .status-valid { color: #10b981; font-weight: bold; }
            .status-near { color: #f59e0b; font-weight: bold; }
            .status-expired { color: #ef4444; font-weight: bold; }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>